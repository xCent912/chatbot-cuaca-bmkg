<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Cuaca & Banjir BMKG - xCent912</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [SALIN SEMUA STYLE DARI VERSI 1 DI ATAS] */
        /* Pastikan semua style CSS dari versi 1 ada di sini */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-cloud-sun-rain"></i> Chatbot AI - Prakiraan Cuaca & Banjir BMKG</h1>
            <p>Dibuat oleh xCent912 | Data BMKG + Gemini AI</p>
            
            <div class="php-info">
                <i class="fas fa-info-circle"></i> 
                Data BMKG diambil langsung via API JavaScript | 
                Status: <span id="apiStatus">Mengecek...</span>
            </div>
        </header>
        
        <div class="main-content">
            <!-- [SALIN SEMUA BAGIAN HTML DARI VERSI 1] -->
            <!-- Chat section, weather section, dll -->
        </div>
        
        <footer>
            <p>Dibuat dengan ‚ù§Ô∏è oleh xCent912 | JavaScript + Gemini AI</p>
            <p><a href="https://github.com/xCent912" style="color: var(--secondary); text-decoration: none;">
                <i class="fab fa-github"></i> GitHub: xCent912
            </a></p>
        </footer>
    </div>

    <script>
        // ========== KONFIGURASI ==========
        const GEMINI_API_KEY = "AIzaSyBwjOfoKCFCjwxB58WuOeo7fefzwKBsxds"; // GANTI INI!
        const BMKG_API_URL = "https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=31.71.01.1001";
        
        let weatherData = null;
        
        // ========== FUNGSI AMBIL DATA BMKG ==========
        async function fetchBMKGData() {
            try {
                console.log("üîÑ Mengambil data dari BMKG...");
                
                // Coba endpoint utama
                const response = await fetch(BMKG_API_URL);
                
                if (!response.ok) {
                    // Jika gagal, gunakan data contoh
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Validasi data
                if (!data.lokasi || !data.data) {
                    throw new Error("Format data tidak valid");
                }
                
                weatherData = data;
                console.log("‚úÖ Data BMKG berhasil diambil");
                
                // Update tampilan
                displayLocationInfo();
                displayWeatherTable();
                updateWeatherForecast();
                updateFloodAnalysis();
                
                document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
                
                return data;
                
            } catch (error) {
                console.error("‚ùå Error mengambil data BMKG:", error);
                
                // Gunakan data contoh
                useSampleData();
                
                // Tampilkan pesan error
                const forecastContainer = document.getElementById('weatherForecast');
                forecastContainer.innerHTML = `
                    <div style="color: #e74c3c; padding: 10px; background: #ffeaa7; border-radius: 5px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Gagal mengambil data real-time. Menampilkan data contoh.
                    </div>
                `;
                
                return weatherData;
            }
        }
        
        // ========== DATA CONTOH ==========
        function useSampleData() {
            weatherData = {
                "lokasi": {
                    "adm1": "31",
                    "adm2": "31.71",
                    "adm3": "31.71.01",
                    "adm4": "31.71.01.1001",
                    "provinsi": "DKI Jakarta",
                    "kotkab": "Kota Adm. Jakarta Pusat",
                    "kecamatan": "Gambir",
                    "desa": "Gambir",
                    "lon": 106.8262,
                    "lat": -6.1750,
                    "timezone": "Asia/Jakarta"
                },
                "data": [{
                    "lokasi": {
                        "adm1": "31",
                        "adm2": "31.71",
                        "adm3": "31.71.01",
                        "adm4": "31.71.01.1001",
                        "provinsi": "DKI Jakarta",
                        "kotkab": "Kota Adm. Jakarta Pusat",
                        "kecamatan": "Gambir",
                        "desa": "Gambir",
                        "lon": 106.8262,
                        "lat": -6.1750,
                        "timezone": "+0700",
                        "type": "adm4"
                    },
                    "cuaca": [[
                        {
                            "datetime": new Date(Date.now() + 6*60*60*1000).toISOString(),
                            "t": 26,
                            "weather_desc": "Hujan Ringan",
                            "tp": 1.7,
                            "hu": 84,
                            "ws": 11.6,
                            "wd": "SW",
                            "vs_text": "> 10 km"
                        },
                        {
                            "datetime": new Date(Date.now() + 9*60*60*1000).toISOString(),
                            "t": 28,
                            "weather_desc": "Berawan",
                            "tp": 0.1,
                            "hu": 71,
                            "ws": 11.6,
                            "wd": "SW",
                            "vs_text": "> 10 km"
                        },
                        {
                            "datetime": new Date(Date.now() + 12*60*60*1000).toISOString(),
                            "t": 30,
                            "weather_desc": "Cerah Berawan",
                            "tp": 0,
                            "hu": 67,
                            "ws": 12.9,
                            "wd": "W",
                            "vs_text": "> 10 km"
                        },
                        {
                            "datetime": new Date(Date.now() + 15*60*60*1000).toISOString(),
                            "t": 28,
                            "weather_desc": "Berawan",
                            "tp": 0,
                            "hu": 74,
                            "ws": 13.4,
                            "wd": "SW",
                            "vs_text": "> 10 km"
                        },
                        {
                            "datetime": new Date(Date.now() + 18*60*60*1000).toISOString(),
                            "t": 26,
                            "weather_desc": "Berawan",
                            "tp": 0,
                            "hu": 83,
                            "ws": 14.5,
                            "wd": "SW",
                            "vs_text": "> 10 km"
                        },
                        {
                            "datetime": new Date(Date.now() + 21*60*60*1000).toISOString(),
                            "t": 26,
                            "weather_desc": "Berawan",
                            "tp": 0,
                            "hu": 84,
                            "ws": 12.8,
                            "wd": "SW",
                            "vs_text": "> 10 km"
                        }
                    ]]
                }]
            };
            
            displayLocationInfo();
            displayWeatherTable();
            updateWeatherForecast();
            updateFloodAnalysis();
            document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
        }
        
        // ========== FUNGSI TAMPILAN ==========
        function displayLocationInfo() {
            if (!weatherData) return;
            
            const locationName = document.getElementById('locationName');
            const locationDetails = document.getElementById('locationDetails');
            
            locationName.textContent = `${weatherData.lokasi.kecamatan}, ${weatherData.lokasi.kotkab}`;
            
            locationDetails.innerHTML = `
                <strong>Provinsi:</strong> ${weatherData.lokasi.provinsi}<br>
                <strong>Kota/Kab:</strong> ${weatherData.lokasi.kotkab}<br>
                <strong>Kecamatan:</strong> ${weatherData.lokasi.kecamatan}<br>
                <strong>Koordinat:</strong> ${weatherData.lokasi.lat?.toFixed(4) || '-6.1750'}, ${weatherData.lokasi.lon?.toFixed(4) || '106.8262'}
            `;
        }
        
        function displayWeatherTable() {
            if (!weatherData || !weatherData.data[0]?.cuaca[0]) return;
            
            const tableBody = document.querySelector('.data-table tbody');
            if (!tableBody) return;
            
            let html = '';
            const forecasts = weatherData.data[0].cuaca[0];
            
            forecasts.slice(0, 6).forEach(forecast => {
                const time = new Date(forecast.datetime).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${forecast.weather_desc}</td>
                        <td>${forecast.t}¬∞C</td>
                        <td>${forecast.tp > 0 ? forecast.tp + ' mm' : '-'}</td>
                        <td>${forecast.hu}%</td>
                        <td>${forecast.ws} km/j</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        function updateWeatherForecast() {
            const forecastContainer = document.getElementById('weatherForecast');
            if (!weatherData || !weatherData.data[0]?.cuaca[0]) return;
            
            const forecasts = weatherData.data[0].cuaca[0];
            let html = '<div class="forecast-container">';
            
            forecasts.slice(0, 4).forEach(forecast => {
                const time = new Date(forecast.datetime).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const icon = getWeatherIcon(forecast.weather_desc);
                const rain = forecast.tp > 0 ? ` (${forecast.tp} mm)` : '';
                
                html += `
                    <div class="forecast-item">
                        <div class="forecast-time">${time}</div>
                        <div class="forecast-desc">
                            <div class="weather-icon">
                                <i class="${icon}"></i>
                            </div>
                            ${forecast.weather_desc}${rain}
                        </div>
                        <div class="forecast-temp">${forecast.t}¬∞C</div>
                    </div>
                `;
            });
            
            html += '</div>';
            forecastContainer.innerHTML = html;
        }
        
        function updateFloodAnalysis() {
            if (!weatherData) return;
            
            const floodAnalysis = document.getElementById('floodAnalysis');
            const forecasts = weatherData.data[0]?.cuaca[0] || [];
            
            let totalRain = 0;
            let rainHours = 0;
            
            forecasts.forEach(f => {
                if (f.tp > 0) {
                    totalRain += f.tp;
                    rainHours++;
                }
            });
            
            let riskLevel = 'low';
            let riskText = 'RENDAH';
            let recommendation = 'Risiko rendah. Pantau perkembangan cuaca.';
            
            if (totalRain > 10) {
                riskLevel = 'high';
                riskText = 'TINGGI';
                recommendation = 'Waspada banjir! Siapkan evakuasi jika diperlukan.';
            } else if (totalRain > 5) {
                riskLevel = 'medium';
                riskText = 'SEDANG';
                recommendation = 'Potensi genangan air. Periksa saluran air.';
            }
            
            floodAnalysis.innerHTML = `
                <p><strong>Tingkat risiko:</strong> <span class="warning-level warning-${riskLevel}">${riskText}</span></p>
                <p><strong>Curah hujan total:</strong> ${totalRain.toFixed(1)} mm</p>
                <p><strong>Durasi hujan:</strong> ${rainHours} jam</p>
                <p><strong>Rekomendasi:</strong> ${recommendation}</p>
            `;
        }
        
        // ========== [SALIN SEMUA FUNGSI CHAT & AI DARI SEBELUMNYA] ==========
        // Fungsi sendMessage, getAIResponse, getLocalAIResponse, dll
        
        // ========== INISIALISASI ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("üöÄ Website Chatbot Cuaca dimuat");
            
            // Update status
            document.getElementById('apiStatus').textContent = 
                GEMINI_API_KEY.includes("BwjOfoKCFCjwxB58WuOeo7fefzwKBsxds") 
                ? "Online (AI Lokal)" 
                : "Online (Gemini AI)";
            
            // Ambil data BMKG
            await fetchBMKGData();
            
            // Update waktu setiap detik
            setInterval(() => {
                document.getElementById('updateTime').textContent = 
                    new Date().toLocaleTimeString('id-ID');
            }, 1000);
            
            // Pesan selamat datang
            setTimeout(() => {
                const location = weatherData ? 
                    `${weatherData.lokasi.kecamatan}, ${weatherData.lokasi.provinsi}` : 
                    "Gambir, Jakarta Pusat";
                    
                addMessage(`üëã <strong>Selamat datang di Chatbot Cuaca xCent912!</strong><br><br>
                Data cuaca diambil langsung dari API BMKG.<br>
                Lokasi saat ini: <strong>${location}</strong><br>
                Silakan ajukan pertanyaan tentang cuaca atau banjir!`, 'bot');
            }, 1000);
        });
        
        // Tambahkan tombol reload
        document.querySelector('.location-info').innerHTML += `
            <button onclick="fetchBMKGData()" style="margin-top: 10px; padding: 8px 15px; background-color: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-sync-alt"></i> Muat Ulang Data BMKG
            </button>
        `;
    </script>
</body>
</html>
