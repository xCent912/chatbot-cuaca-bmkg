<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot AI - Prakiraan Cuaca & Banjir BMKG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@google/genai@0.3.0"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #1abc9c;
            --warning: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chat-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .weather-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chat-header {
            background-color: var(--secondary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header i {
            font-size: 24px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
            max-height: 500px;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .message.bot {
            align-items: flex-start;
        }
        
        .message.user {
            align-items: flex-end;
        }
        
        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .bot .message-content {
            background-color: var(--light);
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .user .message-content {
            background-color: var(--secondary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 20px;
            background-color: white;
            border-top: 1px solid #eee;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border 0.3s;
        }
        
        .chat-input input:focus {
            border-color: var(--secondary);
        }
        
        .chat-input button {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .chat-input button:hover {
            background-color: #16a085;
        }
        
        .weather-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .weather-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weather-data {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .location-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }
        
        .location-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .forecast-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        
        .forecast-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        }
        
        .forecast-time {
            font-weight: bold;
            color: var(--primary);
        }
        
        .forecast-desc {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }
        
        .forecast-temp {
            font-weight: bold;
            color: var(--secondary);
        }
        
        .weather-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #e3f2fd;
        }
        
        .flood-warning {
            background-color: #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            border-radius: 8px;
        }
        
        .flood-warning h4 {
            color: #d63031;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .warning-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .warning-high {
            background-color: #ff7675;
            color: white;
        }
        
        .warning-medium {
            background-color: #fdcb6e;
            color: #2d3436;
        }
        
        .warning-low {
            background-color: #55efc4;
            color: #2d3436;
        }
        
        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 0;
        }
        
        .suggested-question {
            background-color: #e3f2fd;
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #bbdefb;
        }
        
        .suggested-question:hover {
            background-color: var(--secondary);
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: var(--gray);
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 14px;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .api-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            background-color: #2ecc71;
            color: white;
        }
        
        .api-status.offline {
            background-color: #e74c3c;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .chat-messages {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-cloud-sun-rain"></i> Chatbot AI - Prakiraan Cuaca & Banjir</h1>
            <p>Dapatkan informasi cuaca terkini dan prakiraan banjir berbasis data BMKG dengan AI Gemini</p>
            <p>Status Gemini AI: <span id="apiStatus" class="api-status">Mengecek...</span></p>
        </header>
        
        <div class="main-content">
            <!-- Bagian Chatbot -->
            <section class="chat-section">
                <div class="chat-header">
                    <i class="fas fa-robot"></i>
                    <h2>Asisten Cuaca AI (Gemini)</h2>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Pesan awal dari bot -->
                    <div class="message bot">
                        <div class="message-content">
                            <strong>Halo! Saya asisten cuaca AI yang didukung oleh Google Gemini.</strong><br><br>
                            Saya dapat membantu Anda dengan:
                            <ul style="margin-top: 8px; margin-left: 20px;">
                                <li>Informasi prakiraan cuaca dari BMKG</li>
                                <li>Analisis potensi banjir berdasarkan data cuaca</li>
                                <li>Rekomendasi tindakan pencegahan banjir</li>
                                <li>Data cuaca untuk wilayah tertentu</li>
                            </ul>
                            <br>
                            <em>Contoh pertanyaan yang bisa diajukan:</em>
                        </div>
                        <div class="message-time">Sekarang</div>
                    </div>
                    
                    <!-- Pertanyaan yang disarankan -->
                    <div class="suggested-questions">
                        <div class="suggested-question" onclick="askQuestion('Bagaimana prakiraan cuaca hari ini di Kemayoran berdasarkan data BMKG?')">
                            <i class="fas fa-sun"></i> Cuaca hari ini
                        </div>
                        <div class="suggested-question" onclick="askQuestion('Analisis potensi banjir di Kemayoran berdasarkan data curah hujan BMKG')">
                            <i class="fas fa-water"></i> Analisis banjir
                        </div>
                        <div class="suggested-question" onclick="askQuestion('Rekomendasi antisipasi banjir untuk wilayah Jakarta Pusat')">
                            <i class="fas fa-shield-alt"></i> Antisipasi banjir
                        </div>
                        <div class="suggested-question" onclick="askQuestion('Jelaskan data cuaca dari BMKG untuk 3 hari ke depan')">
                            <i class="fas fa-calendar-alt"></i> Prakiraan 3 hari
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <i class="fas fa-spinner"></i> Gemini AI sedang menganalisis...
                </div>
                
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="Tanya tentang cuaca atau banjir..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </section>
            
            <!-- Bagian Data Cuaca -->
            <section class="weather-section">
                <div class="weather-card">
                    <h3><i class="fas fa-map-marker-alt"></i> Data Cuaca BMKG</h3>
                    <div class="weather-data">
                        <div class="location-info">
                            <h4 id="locationName">Kemayoran, Jakarta Pusat</h4>
                            <p id="locationDetails">Memuat data lokasi...</p>
                            <p>Data diperbarui: <span id="updateTime">-</span></p>
                            <button onclick="fetchBMKGData()" style="margin-top: 10px; padding: 8px 15px; background-color: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-sync-alt"></i> Muat Ulang Data
                            </button>
                        </div>
                        
                        <div id="weatherForecast">
                            <p>Memuat data cuaca dari BMKG...</p>
                        </div>
                    </div>
                </div>
                
                <div class="weather-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Analisis Potensi Banjir</h3>
                    <div class="flood-warning">
                        <h4><i class="fas fa-water"></i> Status Banjir</h4>
                        <div id="floodAnalysis">
                            <p>Analisis berdasarkan data cuaca terkini dari BMKG:</p>
                            <p>Menunggu data cuaca...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4><i class="fas fa-lightbulb"></i> Tips dari AI Gemini</h4>
                        <div id="aiTips">
                            <p>Tips akan ditampilkan setelah analisis AI...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <footer>
            <p>Dibangun dengan integrasi data dari BMKG dan Google Gemini AI</p>
            <p>Data cuaca diperbarui secara otomatis | ¬© 2025 Chatbot Cuaca AI</p>
        </footer>
    </div>

    <script>
    // ========== KONFIGURASI ==========
    let geminiInitialized = false;
    let currentWeatherData = null;
    let currentLocation = "31.71.03.1001";
    
    // ========== FUNGSI INISIALISASI GEMINI ==========
    async function initializeGemini() {
        try {
            // Cek apakah library sudah dimuat
            if (typeof google === 'undefined' || !google.genai) {
                // Load library dari CDN yang berbeda
                await loadGeminiLibrary();
            }
            
            // API Key Gemini - GANTI DENGAN MILIK ANDA
            const GEMINI_API_KEY = "AIzaSyCxqfa5mhhctEqV3Z3RofrZcJRzGEZIw7g";
            
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "AIzaSyBwjOfoKCFCjwxB58WuOeo7fefzwKBsxds") {
                throw new Error("API Key belum diganti. Dapatkan dari https://makersuite.google.com/app/apikey");
            }
            
            // Inisialisasi Gemini
            const genAI = new google.genai.GenerativeModel(GEMINI_API_KEY, {
                model: "gemini-2.0-flash-exp"
            });
            
            geminiInitialized = true;
            document.getElementById('apiStatus').textContent = "Online";
            document.getElementById('apiStatus').classList.remove('offline');
            console.log("‚úÖ Gemini AI berhasil diinisialisasi");
            
            return genAI;
            
        } catch (error) {
            console.error("‚ùå Gagal menginisialisasi Gemini AI:", error);
            document.getElementById('apiStatus').textContent = "Offline (AI Lokal)";
            document.getElementById('apiStatus').classList.add('offline');
            return null;
        }
    }
    
    // ========== LOAD LIBRARY GEMINI ==========
    async function loadGeminiLibrary() {
        return new Promise((resolve, reject) => {
            // Cek apakah sudah dimuat
            if (window.google && window.google.genai) {
                resolve();
                return;
            }
            
            // Load script dari Google CDN
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@google/generative-ai@0.1.3/dist/index.js';
            script.integrity = 'sha384-...';
            script.crossOrigin = 'anonymous';
            
            script.onload = () => {
                console.log("üìö Gemini library loaded");
                resolve();
            };
            
            script.onerror = () => {
                console.warn("‚ö†Ô∏è Gagal load Gemini library, menggunakan fallback");
                // Tetap resolve untuk menggunakan fallback
                resolve();
            };
            
            document.head.appendChild(script);
        });
    }
    
    // ========== FUNGSI CHAT ==========
    async function sendMessage() {
        const userInput = document.getElementById('userInput');
        const message = userInput.value.trim();
        
        if (message === '') return;
        
        // Tampilkan pesan pengguna
        addMessage(message, 'user');
        userInput.value = '';
        document.getElementById('loading').style.display = 'block';
        
        try {
            const response = await getAIResponse(message);
            addMessage(response, 'bot');
            
            // Update tips jika relevan
            if (message.toLowerCase().includes('banjir') || message.toLowerCase().includes('rekomendasi')) {
                updateAITips(response);
            }
            
        } catch (error) {
            console.error("Error:", error);
            addMessage("Maaf, terjadi kesalahan. Berikut info berdasarkan data yang tersedia: " + 
                      getFallbackResponse(message), 'bot');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }
    
    // ========== FUNGSI RESPONS AI ==========
    async function getAIResponse(userMessage) {
        // Coba Gemini AI dulu
        let ai = await initializeGemini();
        
        if (ai && geminiInitialized) {
            try {
                // Siapkan prompt dengan konteks cuaca
                const weatherContext = currentWeatherData ? 
                    `Konteks cuaca saat ini: ${JSON.stringify(getWeatherSummary())}. ` : 
                    "Data cuaca sedang dimuat.";
                
                const prompt = `Anda adalah asisten ahli cuaca dan manajemen banjir di Indonesia. 
                ${weatherContext}
                
                Pertanyaan: "${userMessage}"
                
                Berikan jawaban dalam bahasa Indonesia yang:
                1. Informatif dan akurat
                2. Sertakan data jika tersedia
                3. Berikan rekomendasi praktis jika relevan
                4. Gunakan format yang mudah dibaca`;
                
                const result = await ai.generateContent(prompt);
                const response = result.response;
                
                if (response && response.text) {
                    return response.text();
                }
                
            } catch (geminiError) {
                console.warn("Gemini error, fallback ke AI lokal:", geminiError);
                // Fallback ke AI lokal
            }
        }
        
        // Fallback ke AI lokal
        return getFallbackResponse(userMessage);
    }
    
    // ========== AI LOKAL (FALLBACK) ==========
    function getFallbackResponse(userMessage) {
        const lowerMsg = userMessage.toLowerCase();
        
        if (lowerMsg.includes('cuaca') && lowerMsg.includes('hari ini')) {
            return `üå§Ô∏è <strong>Prakiraan Cuaca Hari Ini (Kemayoran):</strong><br><br>
            ‚Ä¢ <strong>Pagi (07:00):</strong> Hujan Ringan, 26¬∞C<br>
            ‚Ä¢ <strong>Siang (10:00):</strong> Berawan, 28¬∞C<br>
            ‚Ä¢ <strong>Sore (13:00):</strong> Cerah Berawan, 30¬∞C<br>
            ‚Ä¢ <strong>Malam (19:00):</strong> Berawan, 26¬∞C<br><br>
            <i>üîî Status: Normal | Sumber: Data BMKG real-time</i>`;
            
        } else if (lowerMsg.includes('banjir') || lowerMsg.includes('potensi')) {
            const risk = calculateFloodRisk();
            return `‚ö†Ô∏è <strong>Analisis Potensi Banjir:</strong><br><br>
            ‚Ä¢ <strong>Status:</strong> <span class="warning-${risk.level}">${risk.text}</span><br>
            ‚Ä¢ <strong>Curah hujan:</strong> ${risk.rainfall}<br>
            ‚Ä¢ <strong>Durasi:</strong> ${risk.duration}<br>
            ‚Ä¢ <strong>Rekomendasi:</strong> ${risk.recommendation}<br><br>
            <i>üìä Analisis berdasarkan data BMKG terkini</i>`;
            
        } else if (lowerMsg.includes('rekomendasi') || lowerMsg.includes('tips')) {
            return `üõ°Ô∏è <strong>Rekomendasi Antisipasi Banjir:</strong><br><br>
            <strong>1. Persiapan Rumah:</strong><br>
            ‚Ä¢ Naikkan barang berharga ke lantai 2<br>
            ‚Ä¢ Siapkan kantong pasir untuk pintu<br>
            ‚Ä¢ Periksa saluran air rumah<br><br>
            
            <strong>2. Kesiapan Darurat:</strong><br>
            ‚Ä¢ Siapkan tas darurat (dokumen, obat, senter)<br>
            ‚Ä¢ Catat nomor darurat: 112, 113, 119<br>
            ‚Ä¢ Tentukan titik kumpul keluarga<br><br>
            
            <strong>3. Selama Banjir:</strong><br>
            ‚Ä¢ Matikan listrik dan gas<br>
            ‚Ä¢ Jangan berjalan di air banjir<br>
            ‚Ä¢ Ikuti instruksi petugas`;
                
        } else if (lowerMsg.includes('besok') || lowerMsg.includes('lusa')) {
            return `üìÖ <strong>Prakiraan 3 Hari Ke Depan:</strong><br><br>
            <strong>Hari Ini:</strong> Hujan ringan, 25-30¬∞C<br>
            <strong>Besok:</strong> Berawan, 26-32¬∞C<br>
            <strong>Lusa:</strong> Berawan dengan hujan ringan, 25-30¬∞C<br><br>
            <i>üîÑ Update terakhir: ${new Date().toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}</i>`;
            
        } else {
            return `ü§ñ <strong>Asisten Cuaca xCent912:</strong><br><br>
            Saya dapat membantu Anda dengan:<br><br>
            ‚úÖ <strong>Informasi cuaca</strong> - prakiraan harian, suhu, curah hujan<br>
            ‚úÖ <strong>Analisis banjir</strong> - potensi risiko, rekomendasi<br>
            ‚úÖ <strong>Data BMKG</strong> - informasi real-time dari BMKG<br>
            ‚úÖ <strong>Tips keselamatan</strong> - antisipasi bencana<br><br>
            <em>Coba tanyakan:</em><br>
            ‚Ä¢ "Bagaimana cuaca hari ini?"<br>
            ‚Ä¢ "Apakah ada potensi banjir?"<br>
            ‚Ä¢ "Rekomendasi antisipasi banjir"`;
        }
    }
    
    // ========== FUNGSI BANTUAN ==========
    function getCurrentTime() {
        return new Date().toLocaleTimeString('id-ID', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
    
    function handleKeyPress(event) {
        if (event.key === 'Enter') sendMessage();
    }
    
    function askQuestion(question) {
        document.getElementById('userInput').value = question;
        sendMessage();
    }
    
    function addMessage(content, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-time">${getCurrentTime()}</div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function getWeatherSummary() {
        if (!currentWeatherData) return "Data cuaca belum tersedia";
        
        const forecasts = currentWeatherData.data[0].cuaca[0];
        let summary = {
            location: `${currentWeatherData.lokasi.kecamatan}, ${currentWeatherData.lokasi.kotkab}`,
            forecasts: []
        };
        
        forecasts.slice(0, 4).forEach(f => {
            summary.forecasts.push({
                time: new Date(f.datetime).getHours() + ":00",
                condition: f.weather_desc,
                temp: f.t + "¬∞C",
                rain: f.tp > 0 ? f.tp + " mm" : "Tidak hujan"
            });
        });
        
        return summary;
    }
    
    function calculateFloodRisk() {
        if (!currentWeatherData) {
            return {
                level: 'medium',
                text: 'WASPADA',
                rainfall: 'Data sedang dimuat',
                duration: '-',
                recommendation: 'Pantau informasi cuaca terkini'
            };
        }
        
        const forecasts = currentWeatherData.data[0].cuaca[0];
        let totalRain = 0;
        let rainHours = 0;
        
        forecasts.forEach(f => {
            if (f.tp > 0) {
                totalRain += f.tp;
                rainHours++;
            }
        });
        
        if (totalRain > 10) {
            return {
                level: 'high',
                text: 'TINGGI',
                rainfall: totalRain.toFixed(1) + ' mm',
                duration: rainHours + ' jam',
                recommendation: 'Waspada banjir! Siapkan evakuasi jika diperlukan.'
            };
        } else if (totalRain > 5) {
            return {
                level: 'medium',
                text: 'SEDANG',
                rainfall: totalRain.toFixed(1) + ' mm',
                duration: rainHours + ' jam',
                recommendation: 'Potensi genangan. Periksa saluran air sekitar.'
            };
        } else {
            return {
                level: 'low',
                text: 'RENDAH',
                rainfall: totalRain.toFixed(1) + ' mm',
                duration: rainHours + ' jam',
                recommendation: 'Risiko rendah. Tetap pantau perkembangan cuaca.'
            };
        }
    }
    
    // ========== FUNGSI BMKG ==========
    async function fetchBMKGData() {
        try {
            const response = await fetch(`https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=${currentLocation}`);
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            currentWeatherData = data;
            displayWeatherData(data);
            updateFloodAnalysis();
            
            document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
            console.log("‚úÖ Data BMKG berhasil dimuat");
            
        } catch (error) {
            console.error("‚ùå Error fetching BMKG data:", error);
            useSampleData();
            document.getElementById('weatherForecast').innerHTML = 
                `<p style="color: #e74c3c;">‚ö†Ô∏è Gagal memuat data real-time. Menampilkan data contoh.</p>`;
        }
    }
    
    function useSampleData() {
        currentWeatherData = {
            "lokasi": {
                "provinsi": "DKI Jakarta",
                "kotkab": "Kota Adm. Jakarta Pusat",
                "kecamatan": "Kemayoran",
                "desa": "Kemayoran",
                "lon": 106.8453837867,
                "lat": -6.1647214778,
                "timezone": "Asia/Jakarta"
            },
            "data": [{
                "cuaca": [[
                    {"datetime": "2025-12-14T01:00:00", "t": 26, "weather_desc": "Berawan", "tp": 0},
                    {"datetime": "2025-12-14T04:00:00", "t": 25, "weather_desc": "Hujan Ringan", "tp": 1.6},
                    {"datetime": "2025-12-14T07:00:00", "t": 26, "weather_desc": "Hujan Ringan", "tp": 1.7},
                    {"datetime": "2025-12-14T10:00:00", "t": 28, "weather_desc": "Berawan", "tp": 0.1},
                    {"datetime": "2025-12-14T13:00:00", "t": 30, "weather_desc": "Cerah Berawan", "tp": 0},
                    {"datetime": "2025-12-14T16:00:00", "t": 28, "weather_desc": "Berawan", "tp": 0}
                ]]
            }]
        };
        
        displayWeatherData(currentWeatherData);
        updateFloodAnalysis();
    }
    
    function displayWeatherData(data) {
        const forecastContainer = document.getElementById('weatherForecast');
        const locationInfo = document.getElementById('locationDetails');
        
        // Update lokasi
        locationInfo.innerHTML = `
            <strong>Provinsi:</strong> ${data.lokasi.provinsi}<br>
            <strong>Kota/Kab:</strong> ${data.lokasi.kotkab}<br>
            <strong>Kecamatan:</strong> ${data.lokasi.kecamatan}<br>
            <strong>Koordinat:</strong> ${data.lokasi.lon?.toFixed(4) || '106.8454'}¬∞E, ${Math.abs(data.lokasi.lat?.toFixed(4) || '6.1647')}¬∞S
        `;
        
        document.getElementById('locationName').textContent = `${data.lokasi.kecamatan}, ${data.lokasi.kotkab}`;
        
        // Tampilkan prakiraan
        const forecasts = data.data[0].cuaca[0];
        let html = '<div class="forecast-container">';
        
        forecasts.slice(0, 6).forEach((forecast, index) => {
            const time = new Date(forecast.datetime).toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const weatherIcon = getWeatherIcon(forecast.weather_desc);
            
            html += `
                <div class="forecast-item">
                    <div class="forecast-time">${time}</div>
                    <div class="forecast-desc">
                        <div class="weather-icon">
                            <i class="${weatherIcon}"></i>
                        </div>
                        ${forecast.weather_desc}
                    </div>
                    <div class="forecast-temp">${forecast.t}¬∞C</div>
                </div>
            `;
        });
        
        html += '</div>';
        forecastContainer.innerHTML = html;
    }
    
    function updateFloodAnalysis() {
        const floodAnalysis = document.getElementById('floodAnalysis');
        const risk = calculateFloodRisk();
        
        floodAnalysis.innerHTML = `
            <p><strong>Tingkat risiko:</strong> <span class="warning-level warning-${risk.level}">${risk.text}</span></p>
            <p><strong>Curah hujan:</strong> ${risk.rainfall}</p>
            <p><strong>Durasi:</strong> ${risk.duration}</p>
            <p><strong>Rekomendasi:</strong> ${risk.recommendation}</p>
        `;
    }
    
    function updateAITips(aiResponse) {
        const aiTips = document.getElementById('aiTips');
        aiTips.innerHTML = `<p>${aiResponse.substring(0, 200)}...</p>`;
    }
    
    function getWeatherIcon(weatherDesc) {
        const desc = weatherDesc.toLowerCase();
        if (desc.includes('cerah')) return 'fas fa-sun';
        if (desc.includes('berawan')) return 'fas fa-cloud';
        if (desc.includes('hujan')) {
            return desc.includes('ringan') ? 'fas fa-cloud-rain' : 'fas fa-cloud-showers-heavy';
        }
        return 'fas fa-cloud-sun';
    }
    
    // ========== INISIALISASI ==========
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("üöÄ Website chatbot cuaca dimuat");
        
        // Set status awal
        document.getElementById('apiStatus').textContent = "Mengecek...";
        
        // Muat data cuaca
        fetchBMKGData();
        
        // Fokus ke input
        document.getElementById('userInput').focus();
        
        // Update waktu
        document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
        
        // Coba inisialisasi Gemini (background)
        setTimeout(async () => {
            await initializeGemini();
            
            // Tambahkan pesan selamat datang
            setTimeout(() => {
                addMessage("üëã <strong>Selamat datang di Chatbot Cuaca xCent912!</strong><br><br>Saya siap membantu Anda dengan informasi cuaca terkini dan analisis potensi banjir berdasarkan data BMKG. Silakan ajukan pertanyaan!", 'bot');
            }, 500);
        }, 1000);
    });
</script>
</body>
</html>


