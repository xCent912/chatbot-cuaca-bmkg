<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot AI - Prakiraan Cuaca & Banjir BMKG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #1abc9c;
            --warning: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chat-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .weather-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chat-header {
            background-color: var(--secondary);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header i {
            font-size: 24px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
            max-height: 500px;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .message.bot {
            align-items: flex-start;
        }
        
        .message.user {
            align-items: flex-end;
        }
        
        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .bot .message-content {
            background-color: var(--light);
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .user .message-content {
            background-color: var(--secondary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 20px;
            background-color: white;
            border-top: 1px solid #eee;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border 0.3s;
        }
        
        .chat-input input:focus {
            border-color: var(--secondary);
        }
        
        .chat-input button {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .chat-input button:hover {
            background-color: #16a085;
        }
        
        .weather-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .weather-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weather-data {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .location-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }
        
        .location-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .forecast-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        
        .forecast-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        }
        
        .forecast-time {
            font-weight: bold;
            color: var(--primary);
        }
        
        .forecast-desc {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }
        
        .forecast-temp {
            font-weight: bold;
            color: var(--secondary);
        }
        
        .weather-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #e3f2fd;
        }
        
        .flood-warning {
            background-color: #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            border-radius: 8px;
        }
        
        .flood-warning h4 {
            color: #d63031;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .warning-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .warning-high {
            background-color: #ff7675;
            color: white;
        }
        
        .warning-medium {
            background-color: #fdcb6e;
            color: #2d3436;
        }
        
        .warning-low {
            background-color: #55efc4;
            color: #2d3436;
        }
        
        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px 0;
        }
        
        .suggested-question {
            background-color: #e3f2fd;
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #bbdefb;
        }
        
        .suggested-question:hover {
            background-color: var(--secondary);
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: var(--gray);
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 14px;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .api-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            background-color: #2ecc71;
            color: white;
        }
        
        .api-status.offline {
            background-color: #e74c3c;
        }
        
        .wilayah-day {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .wilayah-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .chat-messages {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-cloud-sun-rain"></i> Chatbot AI - Prakiraan Cuaca & Banjir BMKG</h1>
            <p>Dapatkan informasi cuaca terkini dan prakiraan banjir berbasis data BMKG dengan AI Gemini</p>
            <p>Status Gemini AI: <span id="apiStatus" class="api-status">Mengecek...</span></p>
        </header>
        
        <div class="main-content">
            <!-- Bagian Chatbot -->
            <section class="chat-section">
                <div class="chat-header">
                    <i class="fas fa-robot"></i>
                    <h2>Asisten Cuaca AI (Gemini)</h2>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Pesan awal dari bot -->
                    <div class="message bot">
                        <div class="message-content">
                            <strong>Halo! Saya asisten cuaca AI yang didukung oleh Google Gemini.</strong><br><br>
                            Saya dapat membantu Anda dengan:
                            <ul style="margin-top: 8px; margin-left: 20px;">
                                <li>Informasi prakiraan cuaca dari BMKG</li>
                                <li>Analisis potensi banjir berdasarkan data cuaca</li>
                                <li>Rekomendasi tindakan pencegahan banjir</li>
                                <li>Data cuaca untuk wilayah tertentu</li>
                            </ul>
                            <br>
                            <em>Contoh pertanyaan yang bisa diajukan:</em>
                        </div>
                        <div class="message-time">Sekarang</div>
                    </div>
                    
                    <!-- Pertanyaan yang disarankan -->
                    <div class="suggested-questions">
                        <div class="suggested-question" onclick="askQuestion('Bagaimana prakiraan cuaca hari ini di Kemayoran berdasarkan data BMKG?')">
                            <i class="fas fa-sun"></i> Cuaca hari ini
                        </div>
                        <div class="suggested-question" onclick="askQuestion('Analisis potensi banjir di Kemayoran berdasarkan data curah hujan BMKG')">
                            <i class="fas fa-water"></i> Analisis banjir
                        </div>
                        <div class="suggested-question" onclick="askQuestion('Rekomendasi antisipasi banjir untuk wilayah Jakarta Pusat')">
                            <i class="fas fa-shield-alt"></i> Antisipasi banjir
                        </div>
                        <div class="suggested-question" onclick="askQuestion('Jelaskan data cuaca dari BMKG untuk 3 hari ke depan')">
                            <i class="fas fa-calendar-alt"></i> Prakiraan 3 hari
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <i class="fas fa-spinner"></i> Gemini AI sedang menganalisis...
                </div>
                
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="Tanya tentang cuaca atau banjir..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </section>
            
            <!-- Bagian Data Cuaca -->
            <section class="weather-section">
                <div class="weather-card">
                    <h3><i class="fas fa-map-marker-alt"></i> Data Cuaca BMKG</h3>
                    <div class="weather-data">
                        <div class="location-info">
                            <h4 id="locationName">Kemayoran, Jakarta Pusat</h4>
                            <p id="locationDetails">Memuat data lokasi...</p>
                            <p>Data diperbarui: <span id="updateTime">-</span></p>
                            
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button onclick="fetchBMKGData()" style="padding: 8px 15px; background-color: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-sync-alt"></i> Data Cuaca
                                </button>
                                
                                <button onclick="getWeatherData('jakarta')" style="padding: 8px 15px; background-color: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-map"></i> Data Jakarta
                                </button>
                                
                                <button onclick="getWeatherData('jawa barat')" style="padding: 8px 15px; background-color: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-mountain"></i> Jawa Barat
                                </button>
                            </div>
                        </div>
                        
                        <div id="weatherForecast">
                            <p>Memuat data cuaca dari BMKG...</p>
                        </div>
                    </div>
                </div>
                
                <div class="weather-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Analisis Potensi Banjir</h3>
                    <div class="flood-warning">
                        <h4><i class="fas fa-water"></i> Status Banjir</h4>
                        <div id="floodAnalysis">
                            <p>Analisis berdasarkan data cuaca terkini dari BMKG:</p>
                            <p>Menunggu data cuaca...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4><i class="fas fa-lightbulb"></i> Tips dari AI Gemini</h4>
                        <div id="aiTips">
                            <p>Tips akan ditampilkan setelah analisis AI...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <footer>
            <p>Dibangun dengan integrasi data dari BMKG dan Google Gemini AI</p>
            <p>Data cuaca diperbarui secara otomatis | ¬© 2025 Chatbot Cuaca AI</p>
        </footer>
    </div>

<script>
// ========== KONFIGURASI ==========
const GEMINI_API_KEY = "AIzaSyCxqfa5mhhctEqV3Z3RofrZcJRzGEZIw7g";
const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent";
const BMKG_WILAYAH_API = "https://data.bmkg.go.id/DataMKG/MEWS/DigitalForecast/DigitalForecast-";

let currentWeatherData = null;
let currentLocation = "31.71.03.1001";

// Kode wilayah untuk berbagai daerah
const WILAYAH_CODES = {
    "jakarta": "501000",
    "jawa barat": "502000",
    "jawa tengah": "503000",
    "yogyakarta": "504000",
    "jawa timur": "505000",
    "banten": "506000",
    "bali": "507000"
};

// ========== FUNGSI GEMINI DENGAN FETCH API ==========
async function callGeminiAPI(prompt) {
    if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("BwjOfoKCFCjwxB58WuOeo7fefzwKBsxds")) {
        console.warn("‚ö†Ô∏è API Key belum diganti, menggunakan AI lokal");
        return null;
    }
    
    try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{parts: [{text: prompt}]}],
                generationConfig: {temperature: 0.7, maxOutputTokens: 1000}
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const data = await response.json();
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            return data.candidates[0].content.parts[0].text;
        }
        return null;
    } catch (error) {
        console.error("‚ùå Error Gemini API:", error);
        return null;
    }
}

// ========== FUNGSI CHAT ==========
async function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    
    if (message === '') return;
    
    addMessage(message, 'user');
    userInput.value = '';
    
    const loadingEl = document.getElementById('loading');
    loadingEl.style.display = 'block';
    loadingEl.innerHTML = '<i class="fas fa-spinner"></i> AI sedang memproses...';
    
    try {
        let response;
        const geminiResponse = await getGeminiResponse(message);
        
        if (geminiResponse) {
            response = geminiResponse;
            updateAPIStatus("Online (Gemini AI)");
        } else {
            response = getLocalAIResponse(message);
            updateAPIStatus("Online (AI Lokal)");
        }
        
        addMessage(response, 'bot');
        
        if (message.toLowerCase().includes('banjir') || message.toLowerCase().includes('rekomendasi')) {
            updateAITips(response);
        }
        
    } catch (error) {
        console.error("Error:", error);
        const fallback = getLocalAIResponse(message);
        addMessage(`Maaf, terjadi kesalahan. ${fallback}`, 'bot');
        updateAPIStatus("Offline (Error)");
    } finally {
        loadingEl.style.display = 'none';
    }
}

// ========== RESPONS GEMINI ==========
async function getGeminiResponse(userMessage) {
    const weatherContext = currentWeatherData ? 
        `Konteks cuaca saat ini dari BMKG: Lokasi ${currentWeatherData.lokasi.kecamatan}, ${currentWeatherData.lokasi.provinsi}. ` +
        `Data terbaru: ${JSON.stringify(getWeatherSummary())}. ` : 
        "Data cuaca sedang dimuat. ";
    
    const prompt = `Anda adalah asisten ahli cuaca dan manajemen banjir di Indonesia. ${weatherContext}
    
    Pertanyaan pengguna: "${userMessage}"
    
    Jawab dalam bahasa Indonesia dengan format berikut:
    1. Berikan informasi yang akurat berdasarkan data jika tersedia
    2. Sertakan analisis potensi banjir jika relevan
    3. Berikan rekomendasi praktis
    4. Gunakan bahasa yang mudah dipahami
    5. Format dengan paragraf yang jelas
    
    Jangan gunakan markdown, gunakan HTML sederhana seperti <br> untuk baris baru.`;
    
    return await callGeminiAPI(prompt);
}

// ========== AI LOKAL (FALLBACK) - VERSI FIXED ==========
function getLocalAIResponse(userMessage) {
    const lowerMsg = userMessage.toLowerCase();
    const weatherSummary = getWeatherSummary();
    const floodRisk = calculateFloodRisk();
    
    console.log("üîç User message:", lowerMsg);
    
    // 1. PRAKIRAAN 3 HARI
    if (lowerMsg.includes('3 hari') || lowerMsg.includes('tiga hari') || 
        lowerMsg.includes('besok') || lowerMsg.includes('lusa') ||
        lowerMsg.includes('hari ke depan') || lowerMsg.includes('prakiraan cuaca')) {
        
        console.log("‚úÖ Masuk: Prakiraan 3 hari");
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dayAfter = new Date(today);
        dayAfter.setDate(dayAfter.getDate() + 2);
        
        return `üìÖ <strong>PRAKIRAAN CUACA 3 HARI KE DEPAN:</strong><br><br>
        
        <strong>üìç Lokasi:</strong> ${weatherSummary.location}<br>
        <strong>üìä Sumber:</strong> Data BMKG<br><br>
        
        <strong>HARI INI (${today.toLocaleDateString('id-ID', { weekday: 'long' })}):</strong><br>
        ‚Ä¢ Pagi: Hujan Ringan, 25-26¬∞C<br>
        ‚Ä¢ Siang: Berawan, 28-30¬∞C<br>
        ‚Ä¢ Sore: Cerah Berawan, 28-30¬∞C<br>
        ‚Ä¢ Malam: Berawan, 25-26¬∞C<br>
        ‚Ä¢ Curah hujan: 1.6-1.7 mm/jam<br><br>
        
        <strong>BESOK (${tomorrow.toLocaleDateString('id-ID', { weekday: 'long' })}):</strong><br>
        ‚Ä¢ Pagi: Berawan, 27¬∞C<br>
        ‚Ä¢ Siang: Berawan, 31-32¬∞C<br>
        ‚Ä¢ Sore: Berawan, 28-30¬∞C<br>
        ‚Ä¢ Malam: Berawan, 26¬∞C<br>
        ‚Ä¢ Potensi hujan: Ringan (0-2 mm)<br><br>
        
        <strong>LUSA (${dayAfter.toLocaleDateString('id-ID', { weekday: 'long' })}):</strong><br>
        ‚Ä¢ Pagi: Berawan dengan hujan ringan, 26¬∞C<br>
        ‚Ä¢ Siang: Berawan, 30¬∞C<br>
        ‚Ä¢ Sore: Berawan, 28¬∞C<br>
        ‚Ä¢ Malam: Berawan, 25¬∞C<br>
        ‚Ä¢ Potensi hujan: Sedang (2-5 mm)<br><br>
        
        ‚ö†Ô∏è <strong>PERINGATAN:</strong> Prakiraan dapat berubah. Pantau update terbaru dari BMKG.<br>
        <i>üîÑ Update terakhir: ${new Date().toLocaleString('id-ID')}</i>`;
    }
    
    // 2. ANALISIS BANJIR
    else if (lowerMsg.includes('analisis banjir') || 
             (lowerMsg.includes('analisis') && lowerMsg.includes('banjir')) ||
             lowerMsg.includes('potensi banjir')) {
        
        console.log("‚úÖ Masuk: Analisis banjir");
        return `‚ö†Ô∏è <strong>ANALISIS POTENSI BANJIR:</strong><br><br>
        
        <strong>üìç Lokasi Analisis:</strong> ${weatherSummary.location}<br>
        <strong>üìà Data Dasar:</strong><br>
        ‚Ä¢ Curah hujan terkini: ${floodRisk.rainfall}<br>
        ‚Ä¢ Durasi hujan: ${floodRisk.duration}<br>
        ‚Ä¢ Akumulasi 24 jam: ${(parseFloat(floodRisk.rainfall) * 3).toFixed(1)} mm<br><br>
        
        <strong>üîÑ PROSES ANALISIS:</strong><br>
        1. <em>Pengumpulan Data:</em> Monitoring curah hujan per jam dari BMKG<br>
        2. <em>Perhitungan Akumulasi:</em> Total hujan dalam periode tertentu<br>
        3. <em>Penilaian Risiko:</em> Berdasarkan threshold banjir lokal<br>
        4. <em>Faktor Tambahan:</em> Topografi, drainase, kapasitas sungai<br><br>
        
        <strong>üìä HASIL ANALISIS:</strong><br>
        ‚Ä¢ <strong>Level Risiko:</strong> <span class="warning-level warning-${floodRisk.level}">${floodRisk.text}</span><br>
        ‚Ä¢ <strong>Probabilitas:</strong> ${floodRisk.level === 'high' ? 'Tinggi (70%)' : floodRisk.level === 'medium' ? 'Sedang (40%)' : 'Rendah (15%)'}<br>
        ‚Ä¢ <strong>Dampak Potensial:</strong> ${getFloodImpact(floodRisk.level)}<br>
        ‚Ä¢ <strong>Waktu Respon:</strong> ${floodRisk.level === 'high' ? '1-3 jam' : '3-6 jam'}<br><br>
        
        <i>üîç Analisis berdasarkan algoritma risiko banjir dengan data BMKG</i>`;
    }
    
    // 3. REKOMENDASI/ANTISIPASI BANJIR
    else if (lowerMsg.includes('rekomendasi banjir') || 
             lowerMsg.includes('antisipasi banjir') ||
             (lowerMsg.includes('rekomendasi') && lowerMsg.includes('banjir')) ||
             (lowerMsg.includes('antisipasi') && lowerMsg.includes('banjir')) ||
             lowerMsg.includes('tips banjir') || lowerMsg.includes('pencegahan banjir')) {
        
        console.log("‚úÖ Masuk: Rekomendasi banjir");
        return `üõ°Ô∏è <strong>REKOMENDASI ANTISIPASI & PENCEGAHAN BANJIR:</strong><br><br>
        
        <strong>SEBELUM BANJIR (Persiapan):</strong><br>
        ‚úÖ <em>Persiapan Rumah:</em><br>
        1. Pasang penutup bawah pintu (door dam) atau siapkan kantong pasir<br>
        2. Naikkan barang elektronik dan dokumen penting ke lantai atas<br>
        3. Periksa atap, talang, dan saluran pembuangan air<br>
        4. Siapkan pompa air jika memungkinkan<br><br>
        
        ‚úÖ <em>Persiapan Logistik:</em><br>
        1. Tas darurat berisi: dokumen (KTP, KK, sertifikat), obat-obatan pribadi<br>
        2. Makanan tahan lama (3-7 hari), air minum (4 liter/orang/hari)<br>
        3. Penerangan: senter, lilin, powerbank, radio baterai<br>
        4. Pakaian ganti dan selimut<br><br>
        
        <strong>SELAMA BANJIR (Tindakan):</strong><br>
        üö® <em>Keselamatan:</em><br>
        1. MATIKAN listrik dan gas di meteran utama<br>
        2. Jangan berjalan di air mengalir (risiko terseret/sengatan listrik)<br>
        3. Gunakan air bersih yang telah disimpan<br>
        4. Evakuasi ke titik kumpul yang aman jika diperlukan<br><br>
        
        üìû <em>Kontak Darurat:</em><br>
        ‚Ä¢ 112: Call Center Darurat<br>
        ‚Ä¢ 113: Pemadam Kebakaran<br>
        ‚Ä¢ 119: Search and Rescue (SAR)<br>
        ‚Ä¢ 129: Informasi Bencana BPBD<br><br>
        
        <strong>SETELAH BANJIR (Pemulihan):</strong><br>
        üîß <em>Pembersihan:</em><br>
        1. Dokumentasikan kerusakan untuk asuransi<br>
        2. Bersihkan dengan disinfektan (1:10 bleach:air)<br>
        3. Periksa struktur bangunan sebelum huni kembali<br>
        4. Buang makanan yang terkontaminasi<br><br>
        
        <i>üìã Dikembangkan berdasarkan pedoman BNPB</i>`;
    }
    
    // 4. DATA WILAYAH SPESIFIK
    else if (lowerMsg.includes('wilayah') || lowerMsg.includes('daerah') ||
             lowerMsg.includes('jakarta') || lowerMsg.includes('jawa') ||
             lowerMsg.includes('bali') || lowerMsg.includes('banten')) {
        
        console.log("‚úÖ Masuk: Data wilayah spesifik");
        let wilayah = "jakarta";
        if (lowerMsg.includes('jawa barat')) wilayah = "jawa barat";
        else if (lowerMsg.includes('jawa tengah')) wilayah = "jawa tengah";
        else if (lowerMsg.includes('yogyakarta') || lowerMsg.includes('jogja')) wilayah = "yogyakarta";
        else if (lowerMsg.includes('jawa timur')) wilayah = "jawa timur";
        else if (lowerMsg.includes('banten')) wilayah = "banten";
        else if (lowerMsg.includes('bali')) wilayah = "bali";
        
        getWeatherData(wilayah).then(data => {
            if (data) {
                displayWilayahData(data);
                const chatMessages = document.getElementById('chatMessages');
                const lastMessage = chatMessages.lastChild;
                if (lastMessage && lastMessage.querySelector('.message-content')) {
                    lastMessage.querySelector('.message-content').innerHTML += 
                        `<br><br><i>‚úÖ Data wilayah ${data.wilayah} berhasil dimuat!</i>`;
                }
            }
        });
        
        return `üó∫Ô∏è <strong>Mengambil data cuaca untuk wilayah ${wilayah.toUpperCase()}...</strong><br><br>
        <i>‚è≥ Mohon tunggu, sedang mengambil data dari BMKG Digital Forecast...</i>`;
    }
    
    // 5. CUACA HARI INI
    else if (lowerMsg.includes('cuaca hari ini') || 
             lowerMsg.includes('cuaca sekarang') ||
             (lowerMsg.includes('prakiraan') && lowerMsg.includes('hari ini'))) {
        
        console.log("‚úÖ Masuk: Cuaca hari ini");
        return `üå§Ô∏è <strong>PRAKIRAAN CUACA HARI INI (${weatherSummary.location}):</strong><br><br>
        ${weatherSummary.forecasts.map(f => 
            `‚Ä¢ <strong>${f.time}:</strong> ${f.condition}, ${f.temp}, ${f.rain}`
        ).join('<br>')}<br><br>
        <i>üóìÔ∏è Update: ${new Date().toLocaleDateString('id-ID', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })} | Sumber: BMKG</i>`;
    }
    
    // 6. DEFAULT
    else {
        console.log("‚úÖ Masuk: Default response");
        return `ü§ñ <strong>Asisten Cuaca xCent912</strong><br><br>
        Saya dapat membantu Anda dengan:<br><br>
        üìÖ <strong>Prakiraan 3 Hari:</strong> "prakiraan cuaca 3 hari ke depan"<br>
        ‚ö†Ô∏è <strong>Analisis Banjir:</strong> "analisis potensi banjir"<br>
        üõ°Ô∏è <strong>Rekomendasi:</strong> "rekomendasi antisipasi banjir"<br>
        üå§Ô∏è <strong>Cuaca Hari Ini:</strong> "bagaimana cuaca hari ini?"<br>
        üó∫Ô∏è <strong>Data Wilayah:</strong> "data cuaca Jakarta"<br><br>
        <em>Coba ketik salah satu contoh di atas!</em>`;
    }
}

// ========== FUNGSI UNTUK ENDPOINT LAIN BMKG ==========
async function getWeatherData(wilayahCode) {
    if (isNaN(wilayahCode)) {
        const lowerName = wilayahCode.toLowerCase();
        wilayahCode = WILAYAH_CODES[lowerName] || "501000";
    }
    
    const url = `https://data.bmkg.go.id/DataMKG/MEWS/DigitalForecast/DigitalForecast-${wilayahCode}.json`;
    
    console.log(`üì° Mengambil data dari: ${url}`);
    
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        console.log("‚úÖ Data BMKG wilayah berhasil diambil");
        return processWilayahData(data, wilayahCode);
        
    } catch (error) {
        console.error('‚ùå Gagal mengambil data cuaca wilayah:', error);
        await fetchBMKGData();
        return null;
    }
}

function processWilayahData(data, wilayahCode) {
    if (!data || !data.Prakiraan) {
        console.warn("‚ö†Ô∏è Struktur data tidak sesuai");
        return null;
    }
    
    const result = {
        wilayah: data.wilayah || "Tidak diketahui",
        prakiraan: []
    };
    
    const prakiraanHarian = data.Prakiraan.slice(0, 3);
    
    prakiraanHarian.forEach((hari, index) => {
        const dailyForecast = {
            tanggal: hari.tanggal || `Hari ${index + 1}`,
            jam: []
        };
        
        const importantTimes = [6, 12, 18];
        if (hari.jam && Array.isArray(hari.jam)) {
            importantTimes.forEach(hour => {
                const jamData = hari.jam.find(j => parseInt(j.jam) === hour);
                if (jamData) {
                    dailyForecast.jam.push({
                        waktu: `${hour}:00`,
                        cuaca: jamData.cuaca || "Tidak diketahui",
                        suhu: jamData.suhu || "N/A",
                        kelembapan: jamData.kelembapan || "N/A",
                        angin: jamData.angin || "N/A"
                    });
                }
            });
        }
        
        result.prakiraan.push(dailyForecast);
    });
    
    return result;
}

function displayWilayahData(wilayahData) {
    if (!wilayahData) return;
    
    const forecastContainer = document.getElementById('weatherForecast');
    let html = `
        <div class="wilayah-info">
            <h4 style="margin: 0 0 10px 0; color: var(--primary);">
                <i class="fas fa-map"></i> ${wilayahData.wilayah}
            </h4>
            <p style="margin: 0; font-size: 14px; color: var(--dark);">
                <i class="fas fa-info-circle"></i> Data dari Digital Forecast BMKG
            </p>
        </div>
    `;
    
    html += '<div>';
    
    wilayahData.prakiraan.forEach((hari, index) => {
        html += `
            <div class="wilayah-day">
                <h5 style="margin: 0 0 10px 0; color: var(--secondary); border-bottom: 2px solid #f0f0f0; padding-bottom: 5px;">
                    <i class="fas fa-calendar-day"></i> ${hari.tanggal} ${index === 0 ? '(Hari Ini)' : index === 1 ? '(Besok)' : '(Lusa)'}
                </h5>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        `;
        
        hari.jam.forEach(jam => {
            const icon = getWeatherIcon(jam.cuaca);
            html += `
                <div style="flex: 1; min-width: 120px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">
                        <i class="fas fa-clock"></i> ${jam.waktu}
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 30px; height: 30px; background: #e3f2fd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                            <i class="${icon}" style="color: var(--secondary);"></i>
                        </div>
                        <span>${jam.cuaca}</span>
                    </div>
                    <div style="font-size: 12px; color: var(--gray);">
                        <div><i class="fas fa-thermometer-half"></i> ${jam.suhu}¬∞C</div>
                        <div><i class="fas fa-tint"></i> ${jam.kelembapan}%</div>
                        <div><i class="fas fa-wind"></i> ${jam.angin}</div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    forecastContainer.innerHTML = html;
}

// ========== FUNGSI BANTUAN ==========
function getCurrentTime() {
    return new Date().toLocaleTimeString('id-ID', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function handleKeyPress(event) {
    if (event.key === 'Enter') sendMessage();
}

function askQuestion(question) {
    document.getElementById('userInput').value = question;
    sendMessage();
}

function addMessage(content, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    messageDiv.innerHTML = `
        <div class="message-content">${content}</div>
        <div class="message-time">${getCurrentTime()}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function updateAPIStatus(status) {
    const statusEl = document.getElementById('apiStatus');
    statusEl.textContent = status;
    
    if (status.includes("Online")) {
        statusEl.className = "api-status";
    } else {
        statusEl.className = "api-status offline";
    }
}

function getWeatherSummary() {
    if (!currentWeatherData) {
        return {
            location: "Kemayoran, Jakarta Pusat",
            forecasts: [
                { time: "07:00", condition: "Hujan Ringan", temp: "26¬∞C", rain: "1.7 mm" },
                { time: "10:00", condition: "Berawan", temp: "28¬∞C", rain: "0.1 mm" },
                { time: "13:00", condition: "Cerah Berawan", temp: "30¬∞C", rain: "Tidak hujan" },
                { time: "16:00", condition: "Berawan", temp: "28¬∞C", rain: "Tidak hujan" }
            ]
        };
    }
    
    const forecasts = currentWeatherData.data[0].cuaca[0];
    const location = `${currentWeatherData.lokasi.kecamatan || "Kemayoran"}, ${currentWeatherData.lokasi.kotkab || "Jakarta Pusat"}`;
    
    const summary = {
        location: location,
        forecasts: []
    };
    
    forecasts.slice(0, 4).forEach(f => {
        summary.forecasts.push({
            time: new Date(f.datetime).getHours().toString().padStart(2, '0') + ":00",
            condition: f.weather_desc,
            temp: f.t + "¬∞C",
            rain: f.tp > 0 ? f.tp + " mm" : "Tidak hujan"
        });
    });
    
    return summary;
}

function calculateFloodRisk() {
    if (!currentWeatherData) {
        return {
            level: 'medium',
            text: 'WASPADA',
            rainfall: '3.3 mm',
            duration: '2-3 jam',
            recommendation: 'Pantau informasi cuaca BMKG secara berkala'
        };
    }
    
    const forecasts = currentWeatherData.data[0].cuaca[0];
    let totalRain = 0;
    let rainHours = 0;
    
    forecasts.forEach(f => {
        if (f.tp > 0) {
            totalRain += f.tp;
            rainHours++;
        }
    });
    
    if (totalRain > 10) {
        return {
            level: 'high',
            text: 'TINGGI',
            rainfall: totalRain.toFixed(1) + ' mm',
            duration: rainHours + ' jam',
            recommendation: 'Waspada banjir! Siapkan evakuasi, hindari daerah rendah.'
        };
    } else if (totalRain > 5) {
        return {
            level: 'medium',
            text: 'SEDANG',
            rainfall: totalRain.toFixed(1) + ' mm',
            duration: rainHours + ' jam',
            recommendation: 'Potensi genangan. Periksa saluran air dan siapkan tindakan.'
        };
    } else {
        return {
            level: 'low',
            text: 'RENDAH',
            rainfall: totalRain.toFixed(1) + ' mm',
            duration: rainHours + ' jam',
            recommendation: 'Risiko rendah. Tetap pantau perkembangan cuaca.'
        };
    }
}

function getFloodImpact(riskLevel) {
    switch(riskLevel) {
        case 'high': return 'Genangan >50cm, transportasi lumpuh, risiko evakuasi';
        case 'medium': return 'Genangan 20-50cm, gangguan transportasi lokal';
        case 'low': return 'Genangan <20cm, gangguan kecil';
        default: return 'Minimal';
    }
}

// ========== FUNGSI BMKG ==========
async function fetchBMKGData() {
    try {
        const response = await fetch(`https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=${currentLocation}`);
        
        if (!response.ok) {
            const altResponse = await fetch(`https://api.bmkg.go.id/publik/prakiraan-cuaca`);
            if (altResponse.ok) {
                console.log("‚ö†Ô∏è Menggunakan data BMKG umum");
                useSampleData();
                return;
            }
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        currentWeatherData = data;
        displayWeatherData(data);
        updateFloodAnalysis();
        
        document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
        console.log("‚úÖ Data BMKG berhasil dimuat");
        
    } catch (error) {
        console.error("‚ùå Error fetching BMKG data:", error);
        useSampleData();
        document.getElementById('weatherForecast').innerHTML = 
            `<p style="color: #e74c3c;">‚ö†Ô∏è Menggunakan data contoh. API BMKG sedang tidak dapat diakses.</p>`;
    }
}

function useSampleData() {
    currentWeatherData = {
        "lokasi": {
            "provinsi": "DKI Jakarta",
            "kotkab": "Kota Adm. Jakarta Pusat",
            "kecamatan": "Kemayoran",
            "desa": "Kemayoran",
            "lon": 106.8453837867,
            "lat": -6.1647214778,
            "timezone": "Asia/Jakarta"
        },
        "data": [{
            "cuaca": [[
                {"datetime": new Date(Date.now() + 6*60*60*1000).toISOString(), "t": 26, "weather_desc": "Hujan Ringan", "tp": 1.7},
                {"datetime": new Date(Date.now() + 9*60*60*1000).toISOString(), "t": 28, "weather_desc": "Berawan", "tp": 0.1},
                {"datetime": new Date(Date.now() + 12*60*60*1000).toISOString(), "t": 30, "weather_desc": "Cerah Berawan", "tp": 0},
                {"datetime": new Date(Date.now() + 15*60*60*1000).toISOString(), "t": 28, "weather_desc": "Berawan", "tp": 0},
                {"datetime": new Date(Date.now() + 18*60*60*1000).toISOString(), "t": 26, "weather_desc": "Berawan", "tp": 0},
                {"datetime": new Date(Date.now() + 21*60*60*1000).toISOString(), "t": 25, "weather_desc": "Berawan", "tp": 0}
            ]]
        }]
    };
    
    displayWeatherData(currentWeatherData);
    updateFloodAnalysis();
}

function displayWeatherData(data) {
    const forecastContainer = document.getElementById('weatherForecast');
    const locationInfo = document.getElementById('locationDetails');
    
    locationInfo.innerHTML = `
        <strong>Provinsi:</strong> ${data.lokasi.provinsi}<br>
        <strong>Kota/Kab:</strong> ${data.lokasi.kotkab}<br>
        <strong>Kecamatan:</strong> ${data.lokasi.kecamatan}<br>
        <strong>Update:</strong> ${new Date().toLocaleTimeString('id-ID')}
    `;
    
    document.getElementById('locationName').textContent = `${data.lokasi.kecamatan}, ${data.lokasi.kotkab}`;
    
    const forecasts = data.data[0].cuaca[0];
    let html = '<div class="forecast-container">';
    
    forecasts.slice(0, 6).forEach((forecast) => {
        const time = new Date(forecast.datetime).toLocaleTimeString('id-ID', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const weatherIcon = getWeatherIcon(forecast.weather_desc);
        const rainfall = forecast.tp > 0 ? ` (${forecast.tp} mm)` : '';
        
        html += `
            <div class="forecast-item">
                <div class="forecast-time">${time}</div>
                <div class="forecast-desc">
                    <div class="weather-icon">
                        <i class="${weatherIcon}"></i>
                    </div>
                    ${forecast.weather_desc}${rainfall}
                </div>
                <div class="forecast-temp">${forecast.t}¬∞C</div>
            </div>
        `;
    });
    
    html += '</div>';
    forecastContainer.innerHTML = html;
}

function updateFloodAnalysis() {
    const floodAnalysis = document.getElementById('floodAnalysis');
    const risk = calculateFloodRisk();
    
    floodAnalysis.innerHTML = `
        <p><strong>Status:</strong> <span class="warning-level warning-${risk.level}">${risk.text}</span></p>
        <p><strong>Curah Hujan:</strong> ${risk.rainfall}</p>
        <p><strong>Durasi:</strong> ${risk.duration}</p>
        <p><strong>Saran:</strong> ${risk.recommendation}</p>
    `;
}

function updateAITips(aiResponse) {
    const aiTips = document.getElementById('aiTips');
    const tips = aiResponse.replace(/<[^>]*>/g, '').substring(0, 150);
    aiTips.innerHTML = `<p><strong>Tips AI:</strong> ${tips}...</p>`;
}

function getWeatherIcon(weatherDesc) {
    const desc = weatherDesc.toLowerCase();
    if (desc.includes('cerah')) return 'fas fa-sun';
    if (desc.includes('berawan')) return 'fas fa-cloud';
    if (desc.includes('hujan')) {
        return desc.includes('ringan') ? 'fas fa-cloud-rain' : 'fas fa-cloud-showers-heavy';
    }
    if (desc.includes('mendung')) return 'fas fa-cloud';
    return 'fas fa-cloud-sun';
}

// ========== INISIALISASI ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Website Chatbot Cuaca xCent912 dimuat");
    
    updateAPIStatus("Mengecek koneksi...");
    fetchBMKGData();
    
    setTimeout(() => {
        document.getElementById('userInput').focus();
    }, 500);
    
    document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
    
    setTimeout(async () => {
        if (GEMINI_API_KEY && !GEMINI_API_KEY.includes("BwjOfoKCFCjwxB58WuOeo7fefzwKBsxds")) {
            try {
                const test = await callGeminiAPI("Test");
                if (test) {
                    updateAPIStatus("Online (Gemini AI)");
                } else {
                    updateAPIStatus("Online (AI Lokal)");
                }
            } catch {
                updateAPIStatus("Online (AI Lokal)");
            }
        } else {
            updateAPIStatus("Online (AI Lokal) - Ganti API Key untuk Gemini");
        }
        
        setTimeout(() => {
            addMessage(`ü§ñ <strong>Selamat datang di Chatbot Cuaca xCent912!</strong><br><br>
            Saya asisten AI yang siap membantu dengan:<br>
            ‚Ä¢ Prakiraan cuaca dari BMKG<br>
            ‚Ä¢ Analisis potensi banjir<br>
            ‚Ä¢ Rekomendasi keselamatan<br><br>
            Status: <span class="api-status">${document.getElementById('apiStatus').textContent}</span><br>
            Silakan ajukan pertanyaan Anda!`, 'bot');
        }, 1000);
        
    }, 2000);
});

// Ekspos fungsi untuk tombol reload
window.fetchBMKGData = fetchBMKGData;
window.getWeatherData = getWeatherData;
</script>
</body>
</html>
